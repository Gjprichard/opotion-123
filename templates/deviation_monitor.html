{% extends 'layout.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h3 mb-0 text-gray-800">{{ t('option_deviation_monitor') }}</h1>
        <p class="text-muted">{{ t('monitor_options_with_strike_prices_deviating') }} &plusmn;10% {{ t('from_market_price') }}</p>
    </div>
</div>

<!-- Filters Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-left-primary">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('filters') }}</h6>
            </div>
            <div class="card-body">
                <form id="filter-form" class="row g-3 align-items-end">
                    <!-- Symbol -->
                    <div class="col-md-2 mb-2">
                        <label for="symbol-filter" class="form-label">{{ t('symbol') }}</label>
                        <select class="form-select" id="symbol-filter">
                            {% for sym in symbols %}
                            <option value="{{ sym }}" {% if sym == symbol %}selected{% endif %}>{{ sym }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Exchange -->
                    <div class="col-md-2 mb-2">
                        <label for="exchange-filter" class="form-label">{{ t('exchange') }}</label>
                        <select class="form-select" id="exchange-filter">
                            <option value="deribit" selected>Deribit</option>
                            <option value="binance" {% if exchange == 'binance' %}selected{% endif %}>Binance</option>
                            <option value="okx" {% if exchange == 'okx' %}selected{% endif %}>OKX</option>
                        </select>
                    </div>
                    
                    <!-- Option Type -->
                    <div class="col-md-2 mb-2">
                        <label for="option-type-filter" class="form-label">{{ t('option_type') }}</label>
                        <select class="form-select" id="option-type-filter">
                            <option value="" {% if not option_type %}selected{% endif %}>{{ t('all') }}</option>
                            <option value="call" {% if option_type == 'call' %}selected{% endif %}>Call</option>
                            <option value="put" {% if option_type == 'put' %}selected{% endif %}>Put</option>
                        </select>
                    </div>
                    
                    <!-- Time Period -->
                    <div class="col-md-2 mb-2">
                        <label for="time-period-filter" class="form-label">{{ t('time_period') }}</label>
                        <select class="form-select" id="time-period-filter">
                            {% for period_key, period_info in time_periods.items() %}
                            <option value="{{ period_key }}" {% if period_key == current_time_period %}selected{% endif %}>{{ period_info.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Days -->
                    <div class="col-md-2 mb-2">
                        <label for="days-filter" class="form-label">{{ t('days') }}</label>
                        <select class="form-select" id="days-filter">
                            <option value="1" {% if days == 1 %}selected{% endif %}>1 {{ t('day') }}</option>
                            <option value="3" {% if days == 3 %}selected{% endif %}>3 {{ t('days') }}</option>
                            <option value="7" {% if days == 7 %}selected{% endif %}>7 {{ t('days') }}</option>
                            <option value="14" {% if days == 14 %}selected{% endif %}>14 {{ t('days') }}</option>
                            <option value="30" {% if days == 30 %}selected{% endif %}>30 {{ t('days') }}</option>
                        </select>
                    </div>
                    
                    <!-- Volume Change Filter -->
                    <div class="col-md-2 mb-2">
                        <label for="volume-change-filter" class="form-label">{{ t('volume_change_min') }}</label>
                        <select class="form-select" id="volume-change-filter">
                            <option value="0" {% if volume_change_filter == 0 %}selected{% endif %}>{{ t('all') }}</option>
                            <option value="20" {% if volume_change_filter == 20 %}selected{% endif %}>≥ 20%</option>
                            <option value="50" {% if volume_change_filter == 50 %}selected{% endif %}>≥ 50%</option>
                            <option value="100" {% if volume_change_filter == 100 %}selected{% endif %}>≥ 100%</option>
                        </select>
                    </div>
                    
                    <!-- Show anomalies only -->
                    <div class="col-md-6 mb-2 mt-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="anomaly-only-filter" {% if anomaly_only %}checked{% endif %}>
                            <label class="form-check-label" for="anomaly-only-filter">
                                {{ t('show_anomalies_only') }}
                            </label>
                        </div>
                    </div>
                    
                    <!-- Apply Filters Button -->
                    <div class="col-md-6 mb-2 text-end">
                        <button type="button" class="btn btn-primary" id="apply-filters-btn">
                            {{ t('apply_filters') }}
                        </button>
                        <button type="button" class="btn btn-success ms-2" id="refresh-data-btn">
                            <i class="fas fa-sync-alt"></i> {{ t('refresh') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Risk Monitoring Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-primary">{{ t('volaxivity') }}</div>
                        <div class="risk-value mb-1" id="volaxivity-value">--</div>
                        <div class="progress">
                            <div id="volaxivity-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-area fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-success">{{ t('volatility_skew') }}</div>
                        <div class="risk-value mb-1" id="volatility-skew-value">--</div>
                        <div class="progress">
                            <div id="skew-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-balance-scale fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-info">{{ t('put_call_ratio') }}</div>
                        <div class="risk-value mb-1" id="put-call-ratio-value">--</div>
                        <div class="progress">
                            <div id="pcr-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exchange-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-warning">{{ t('reflexivity_indicator') }}</div>
                        <div class="risk-value mb-1" id="reflexivity-value">--</div>
                        <div class="progress">
                            <div id="reflexivity-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-sync-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exchange Comparison Cards -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('exchange_comparison') }}</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Put/Call Ratio Comparison -->
                    <div class="col-md-4 mb-3">
                        <div class="card border-left-info shadow h-100">
                            <div class="card-header py-2">
                                <h6 class="m-0 font-weight-bold text-info">{{ t('put_call_ratio_comparison') }}</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="pcr-comparison-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Volume Distribution -->
                    <div class="col-md-4 mb-3">
                        <div class="card border-left-primary shadow h-100">
                            <div class="card-header py-2">
                                <h6 class="m-0 font-weight-bold text-primary">{{ t('volume_distribution') }}</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="volume-distribution-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Premium Spread -->
                    <div class="col-md-4 mb-3">
                        <div class="card border-left-success shadow h-100">
                            <div class="card-header py-2">
                                <h6 class="m-0 font-weight-bold text-success">{{ t('premium_spread') }}</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="premium-spread-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Alerts Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-left-danger">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-danger">{{ t('active_deviation_alerts') }}</h6>
            </div>
            <div class="card-body">
                {% if active_alerts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>{{ t('time') }}</th>
                                <th>{{ t('symbol') }}</th>
                                <th>{{ t('exchange') }}</th>
                                <th>{{ t('strike') }}</th>
                                <th>{{ t('deviation') }}</th>
                                <th>{{ t('option_type') }}</th>
                                <th>{{ t('trigger') }}</th>
                                <th>{{ t('action') }}</th>
                            </tr>
                        </thead>
                        <tbody id="active-alerts-body">
                            {% for alert in active_alerts %}
                            <tr data-alert-id="{{ alert.id }}">
                                <td>{{ alert.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ alert.symbol }}</td>
                                <td>{{ alert.exchange }}</td>
                                <td>{{ alert.strike_price }}</td>
                                <td>{{ alert.deviation_percent|round(2) }}%</td>
                                <td>{{ alert.option_type.upper() if alert.option_type else '-' }}</td>
                                <td>{{ alert.trigger_condition }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary acknowledge-alert" data-alert-id="{{ alert.id }}">
                                        <i class="fas fa-check"></i> {{ t('acknowledge') }}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <p class="lead">{{ t('no_active_deviation_alerts') }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('deviation_volume_premium_chart') }}</h6>
            </div>
            <div class="card-body">
                <canvas id="deviation-chart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Deviation Data Table -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('deviation_data') }}</h6>
                <div class="dropdown no-arrow">
                    <button class="btn btn-sm btn-outline-secondary" id="export-csv">
                        <i class="fas fa-download fa-sm"></i> {{ t('export_csv') }}
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="deviation-table">
                        <thead>
                            <tr>
                                <th>{{ t('time') }}</th>
                                <th>{{ t('symbol') }}</th>
                                <th>{{ t('exchange') }}</th>
                                <th>{{ t('strike') }}</th>
                                <th>{{ t('market_price') }}</th>
                                <th>{{ t('deviation') }}</th>
                                <th>{{ t('option_type') }}</th>
                                <th>{{ t('expiration') }}</th>
                                <th>{{ t('volume') }}</th>
                                <th>{{ t('volume_change') }}</th>
                                <th>{{ t('premium') }}</th>
                                <th>{{ t('premium_change') }}</th>
                                <th>{{ t('market_change') }}</th>
                                <th>{{ t('status') }}</th>
                            </tr>
                        </thead>
                        <tbody id="deviation-table-body">
                            {% for dev in deviations %}
                            <tr {% if dev.is_anomaly %}class="table-{{ 'info' if dev.anomaly_level == 'attention' else ('warning' if dev.anomaly_level == 'warning' else 'danger') }}"{% endif %}>
                                <td>{{ dev.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ dev.symbol }}</td>
                                <td>{{ dev.exchange }}</td>
                                <td>{{ dev.strike_price }}</td>
                                <td>{{ dev.market_price }}</td>
                                <td>{{ dev.deviation_percent|round(2) }}%</td>
                                <td>{{ dev.option_type.upper() }}</td>
                                <td>{{ dev.expiration_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ dev.volume }}</td>
                                <td>{{ dev.volume_change_percent|round(2) if dev.volume_change_percent else '-' }}%</td>
                                <td>{{ dev.premium }}</td>
                                <td>{{ dev.premium_change_percent|round(2) if dev.premium_change_percent else '-' }}%</td>
                                <td>{{ dev.market_price_change_percent|round(2) if dev.market_price_change_percent else '-' }}%</td>
                                <td>
                                    {% if dev.is_anomaly %}
                                    <span class="badge bg-{{ 'info' if dev.anomaly_level == 'attention' else ('warning' if dev.anomaly_level == 'warning' else 'danger') }}">
                                        {{ dev.anomaly_level.capitalize() }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-success">{{ t('normal') }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" id="toast-container" style="z-index: 5"></div>
{% endblock %}

{% block scripts %}
<script>
    let deviationData = [];
    let deviationChart = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Handle filter application
        document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
        
        // Handle refresh button
        document.getElementById('refresh-data-btn').addEventListener('click', refreshData);
        
        // Handle CSV export
        document.getElementById('export-csv').addEventListener('click', exportCsv);
        
        // Handle alert acknowledgement
        document.querySelectorAll('.acknowledge-alert').forEach(button => {
            button.addEventListener('click', function() {
                const alertId = this.getAttribute('data-alert-id');
                acknowledgeAlert(alertId);
            });
        });
        
        // Fetch initial data for charts and risk indicators
        fetchDeviationData();
        fetchRiskData();
    });
    
    function applyFilters() {
        const symbol = document.getElementById('symbol-filter').value;
        const exchange = document.getElementById('exchange-filter').value;
        const optionType = document.getElementById('option-type-filter').value;
        const timePeriod = document.getElementById('time-period-filter').value;
        const days = document.getElementById('days-filter').value;
        const volumeChangeMin = document.getElementById('volume-change-filter').value;
        const anomalyOnly = document.getElementById('anomaly-only-filter').checked;
        
        // 构建URL参数
        let params = new URLSearchParams({
            symbol: symbol,
            exchange: exchange,
            time_period: timePeriod,
            days: days,
            anomaly_only: anomalyOnly,
            volume_change_min: volumeChangeMin
        });
        
        // 仅当选择了特定期权类型时添加参数
        if (optionType) {
            params.append('option_type', optionType);
        }
        
        // 重定向到带过滤器的视图
        window.location.href = `/deviation-monitor?${params.toString()}`;
    }
    
    function refreshData() {
        // Show spinner on refresh button
        const refreshBtn = document.getElementById('refresh-data-btn');
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
        refreshBtn.disabled = true;
        
        // Fetch fresh data
        Promise.all([
            fetchDeviationData(true),
            fetchRiskData()
        ]).finally(() => {
            // Restore button state after fetch completes (success or failure)
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        });
    }
    
    async function fetchRiskData() {
        const symbol = document.getElementById('symbol-filter').value;
        const timePeriod = document.getElementById('time-period-filter').value;
        
        try {
            const response = await fetch(`/api/dashboard/data?symbol=${symbol}&days=30&time_period=${timePeriod}`);
            const data = await response.json();
            
            if (response.ok) {
                // Update risk indicator values
                updateRiskIndicators(symbol, data, timePeriod);
            } else {
                console.error('Error fetching risk data:', data.message);
            }
        } catch (error) {
            console.error('Fetch error for risk data:', error);
        }
    }
    
    function updateRiskIndicators(symbol, data, timePeriod) {
        if (!data || !data.timestamps || data.timestamps.length === 0) {
            console.warn('No risk data available');
            return;
        }
        
        // Get the latest data point
        const lastIndex = data.timestamps.length - 1;
        const volaxivity = data.volaxivity ? data.volaxivity[lastIndex] : null;
        const volatilitySkew = data.volatility_skew ? data.volatility_skew[lastIndex] : null;
        const putCallRatio = data.put_call_ratio ? data.put_call_ratio[lastIndex] : null;
        const reflexivity = data.reflexivity_indicator ? data.reflexivity_indicator[lastIndex] : null;
        
        // Update UI values
        updateElementText('volaxivity-value', volaxivity ? volaxivity.toFixed(2) : 'N/A');
        updateElementText('volatility-skew-value', volatilitySkew ? volatilitySkew.toFixed(2) : 'N/A');
        updateElementText('put-call-ratio-value', putCallRatio ? putCallRatio.toFixed(2) : 'N/A');
        updateElementText('reflexivity-value', reflexivity ? (reflexivity * 100).toFixed(2) + '%' : 'N/A');
        
        // Set thresholds based on time period
        let volaxivityLevels, skewLevels, pcrLevels, reflexivityLevels;
        
        switch(timePeriod) {
            case '15m':
                volaxivityLevels = [15, 25, 35];
                skewLevels = [0.3, 0.7, 1.2];
                pcrLevels = [1.1, 1.4, 1.8];
                reflexivityLevels = [0.2, 0.4, 0.6];
                break;
            case '1h':
                volaxivityLevels = [18, 28, 38];
                skewLevels = [0.4, 0.8, 1.3];
                pcrLevels = [1.15, 1.45, 1.9];
                reflexivityLevels = [0.25, 0.45, 0.65];
                break;
            case '4h':
                volaxivityLevels = [20, 30, 40];
                skewLevels = [0.5, 1.0, 1.5];
                pcrLevels = [1.2, 1.5, 2.0];
                reflexivityLevels = [0.3, 0.5, 0.7];
                break;
            case '1d':
                volaxivityLevels = [22, 32, 42];
                skewLevels = [0.6, 1.1, 1.6];
                pcrLevels = [1.25, 1.55, 2.1];
                reflexivityLevels = [0.35, 0.55, 0.75];
                break;
            case '7d':
                volaxivityLevels = [25, 35, 45];
                skewLevels = [0.7, 1.2, 1.7];
                pcrLevels = [1.3, 1.6, 2.2];
                reflexivityLevels = [0.4, 0.6, 0.8];
                break;
            case '30d':
                volaxivityLevels = [30, 40, 50];
                skewLevels = [0.8, 1.3, 1.8];
                pcrLevels = [1.35, 1.7, 2.3];
                reflexivityLevels = [0.45, 0.65, 0.85];
                break;
            default:
                volaxivityLevels = [20, 30, 40];
                skewLevels = [0.5, 1.0, 1.5];
                pcrLevels = [1.2, 1.5, 2.0];
                reflexivityLevels = [0.3, 0.5, 0.7];
        }
        
        // Update risk level indicators
        updateRiskLevelIndicator('volaxivity-indicator', volaxivity, volaxivityLevels);
        updateRiskLevelIndicator('skew-indicator', volatilitySkew, skewLevels);
        updateRiskLevelIndicator('pcr-indicator', putCallRatio, pcrLevels);
        updateRiskLevelIndicator('reflexivity-indicator', reflexivity, reflexivityLevels);
    }
    
    function updateElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
        }
    }
    
    function updateRiskLevelIndicator(elementId, value, thresholds) {
        const indicator = document.getElementById(elementId);
        if (!indicator) return;
        
        // Remove previous classes
        indicator.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-info', 'bg-secondary');
        
        // Determine risk level
        if (value === null || value === undefined) {
            indicator.classList.add('bg-secondary');
            indicator.style.width = '0%';
        } else if (value < thresholds[0]) {
            indicator.classList.add('bg-success');
            indicator.style.width = (value / thresholds[0] * 25) + '%';
        } else if (value < thresholds[1]) {
            indicator.classList.add('bg-info');
            indicator.style.width = '50%';
        } else if (value < thresholds[2]) {
            indicator.classList.add('bg-warning');
            indicator.style.width = '75%';
        } else {
            indicator.classList.add('bg-danger');
            indicator.style.width = '100%';
        }
    }
    
    async function fetchDeviationData(showToastOnSuccess = false) {
        const symbol = document.getElementById('symbol-filter').value;
        const exchange = document.getElementById('exchange-filter').value;
        const optionType = document.getElementById('option-type-filter').value;
        const timePeriod = document.getElementById('time-period-filter').value;
        const days = document.getElementById('days-filter').value;
        const volumeChangeMin = document.getElementById('volume-change-filter').value;
        const anomalyOnly = document.getElementById('anomaly-only-filter').checked;
        
        // 构建URL参数
        let params = new URLSearchParams({
            symbol: symbol,
            exchange: exchange,
            time_period: timePeriod,
            days: days,
            anomaly_only: anomalyOnly,
            volume_change_min: volumeChangeMin
        });
        
        // 仅当选择了特定期权类型时添加参数
        if (optionType) {
            params.append('option_type', optionType);
        }
        
        try {
            const response = await fetch(`/api/deviation/data?${params.toString()}`);
            const data = await response.json();
            
            if (response.ok) {
                deviationData = data;
                createDeviationChart(data);
                updateDeviationTable(data);
                createExchangeComparisonCharts(data);
                
                if (showToastOnSuccess) {
                    showToast('Data refreshed successfully', 'success');
                }
            } else {
                console.error('Error fetching deviation data:', data.message);
                showToast(`Error loading data: ${data.message}`, 'danger');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            showToast('Error connecting to server', 'danger');
        }
    }
    
    function createDeviationChart(data) {
        // Sort data by timestamp
        data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        // Extract data for chart
        const timestamps = data.map(item => item.timestamp);
        const deviationPercents = data.map(item => item.deviation_percent);
        const volumeChanges = data.map(item => item.volume_change_percent || 0);
        const premiumChanges = data.map(item => item.premium_change_percent || 0);
        
        // Create chart
        const ctx = document.getElementById('deviation-chart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (deviationChart) {
            deviationChart.destroy();
        }
        
        deviationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [
                    {
                        label: 'Deviation %',
                        data: deviationPercents,
                        borderColor: 'rgba(78, 115, 223, 1)',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Volume Change %',
                        data: volumeChanges,
                        borderColor: 'rgba(28, 200, 138, 1)',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Premium Change %',
                        data: premiumChanges,
                        borderColor: 'rgba(246, 194, 62, 1)',
                        backgroundColor: 'rgba(246, 194, 62, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Deviation %'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Change %'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
    
    function updateDeviationTable(data) {
        const tableBody = document.getElementById('deviation-table-body');
        tableBody.innerHTML = '';
        
        data.forEach(item => {
            const row = document.createElement('tr');
            
            // Add anomaly highlighting
            if (item.is_anomaly) {
                const levelClass = item.anomaly_level === 'attention' ? 'info' : 
                                  item.anomaly_level === 'warning' ? 'warning' : 'danger';
                row.classList.add(`table-${levelClass}`);
            }
            
            row.innerHTML = `
                <td>${item.timestamp}</td>
                <td>${item.symbol}</td>
                <td>${item.exchange}</td>
                <td>${item.strike_price}</td>
                <td>${item.market_price}</td>
                <td>${item.deviation_percent.toFixed(2)}%</td>
                <td>${item.option_type.toUpperCase()}</td>
                <td>${item.expiration_date}</td>
                <td>${item.volume}</td>
                <td>${item.volume_change_percent ? item.volume_change_percent.toFixed(2) + '%' : '-'}</td>
                <td>${item.premium}</td>
                <td>${item.premium_change_percent ? item.premium_change_percent.toFixed(2) + '%' : '-'}</td>
                <td>${item.market_price_change_percent ? item.market_price_change_percent.toFixed(2) + '%' : '-'}</td>
                <td>
                    ${item.is_anomaly ? 
                      `<span class="badge bg-${item.anomaly_level === 'attention' ? 'info' : (item.anomaly_level === 'warning' ? 'warning' : 'danger')}">
                          ${item.anomaly_level.charAt(0).toUpperCase() + item.anomaly_level.slice(1)}
                       </span>` : 
                      '<span class="badge bg-success">Normal</span>'}
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    function acknowledgeAlert(alertId) {
        fetch('/api/deviation/acknowledge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ alert_id: alertId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the alert from UI
                const alertRow = document.querySelector(`tr[data-alert-id="${alertId}"]`);
                if (alertRow && alertRow.parentNode) {
                    alertRow.parentNode.removeChild(alertRow);
                }
                
                // Show success message
                showToast('Alert acknowledged', 'success');
                
                // If no more alerts, show the "no alerts" message
                const alertsBody = document.getElementById('active-alerts-body');
                if (alertsBody && alertsBody.children.length === 0) {
                    const alertsCard = alertsBody.closest('.card-body');
                    if (alertsCard) {
                        alertsCard.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <p class="lead">No active deviation alerts</p>
                            </div>
                        `;
                    }
                }
            } else {
                showToast(`Error: ${data.message}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error connecting to server', 'danger');
        });
    }
    
    function exportCsv() {
        if (deviationData.length === 0) {
            showToast('No data to export', 'warning');
            return;
        }
        
        // Define CSV headers
        const headers = [
            'Timestamp', 'Symbol', 'Exchange', 'Strike Price', 'Market Price', 'Deviation %', 
            'Option Type', 'Expiration Date', 'Volume', 'Volume Change %', 
            'Premium', 'Premium Change %', 'Market Price Change %', 'Is Anomaly', 'Anomaly Level'
        ];
        
        // Create CSV content
        const csvRows = [headers.join(',')];
        
        deviationData.forEach(item => {
            const row = [
                item.timestamp,
                item.symbol,
                item.exchange,
                item.strike_price,
                item.market_price,
                item.deviation_percent,
                item.option_type,
                item.expiration_date,
                item.volume,
                item.volume_change_percent || '',
                item.premium,
                item.premium_change_percent || '',
                item.market_price_change_percent || '',
                item.is_anomaly,
                item.anomaly_level || ''
            ];
            
            // Escape any commas in the data
            const escapedRow = row.map(field => {
                if (field === null || field === undefined) return '';
                const str = String(field);
                return str.includes(',') ? `"${str}"` : str;
            });
            
            csvRows.push(escapedRow.join(','));
        });
        
        // Create a download link
        const csvContent = 'data:text/csv;charset=utf-8,' + csvRows.join('\n');
        const encodedUri = encodeURI(csvContent);
        
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `deviation_data_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // 创建交易所比较图表
    function createExchangeComparisonCharts(data) {
        // 为每个交易所收集相关数据
        const exchanges = [...new Set(data.map(item => item.exchange))];
        if (exchanges.length <= 1) {
            // 如果只有一个交易所，显示提示信息
            document.querySelectorAll('#pcr-comparison-chart, #volume-distribution-chart, #premium-spread-chart').forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#666';
                ctx.fillText('至少需要两个交易所的数据来进行比较', canvas.width / 2, canvas.height / 2);
            });
            return;
        }

        // 1. Put/Call Ratio 比较图表
        createPutCallRatioComparisonChart(data, exchanges);
        
        // 2. 成交量分布图表
        createVolumeDistributionChart(data, exchanges);
        
        // 3. 期权溢价差异图表
        createPremiumSpreadChart(data, exchanges);
    }
    
    // 创建看跌/看涨比率比较图表
    function createPutCallRatioComparisonChart(data, exchanges) {
        const ctx = document.getElementById('pcr-comparison-chart').getContext('2d');
        
        // 计算每个交易所的看跌/看涨比率
        const pcrData = {};
        exchanges.forEach(exchange => {
            const exchangeData = data.filter(item => item.exchange === exchange);
            const calls = exchangeData.filter(item => item.option_type.toLowerCase() === 'call');
            const puts = exchangeData.filter(item => item.option_type.toLowerCase() === 'put');
            
            // 使用成交量作为权重
            const callVolume = calls.reduce((sum, item) => sum + item.volume, 0);
            const putVolume = puts.reduce((sum, item) => sum + item.volume, 0);
            
            const ratio = callVolume > 0 ? putVolume / callVolume : 0;
            pcrData[exchange] = parseFloat(ratio.toFixed(2));
        });
        
        // 创建图表
        if (window.pcrComparisonChart) {
            window.pcrComparisonChart.destroy();
        }
        
        window.pcrComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: exchanges,
                datasets: [{
                    label: '看跌/看涨比率',
                    data: exchanges.map(exchange => pcrData[exchange]),
                    backgroundColor: [
                        'rgba(78, 115, 223, 0.7)',
                        'rgba(28, 200, 138, 0.7)',
                        'rgba(246, 194, 62, 0.7)'
                    ],
                    borderColor: [
                        'rgba(78, 115, 223, 1)',
                        'rgba(28, 200, 138, 1)',
                        'rgba(246, 194, 62, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '比率'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `比率: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 创建成交量分布图表
    function createVolumeDistributionChart(data, exchanges) {
        const ctx = document.getElementById('volume-distribution-chart').getContext('2d');
        
        // 计算每个交易所的总成交量
        const volumeData = {};
        let totalVolume = 0;
        
        exchanges.forEach(exchange => {
            const exchangeData = data.filter(item => item.exchange === exchange);
            const volume = exchangeData.reduce((sum, item) => sum + item.volume, 0);
            volumeData[exchange] = volume;
            totalVolume += volume;
        });
        
        // 计算百分比
        exchanges.forEach(exchange => {
            volumeData[exchange] = totalVolume > 0 ? 
                parseFloat(((volumeData[exchange] / totalVolume) * 100).toFixed(2)) : 0;
        });
        
        // 创建图表
        if (window.volumeDistributionChart) {
            window.volumeDistributionChart.destroy();
        }
        
        window.volumeDistributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: exchanges,
                datasets: [{
                    data: exchanges.map(exchange => volumeData[exchange]),
                    backgroundColor: [
                        'rgba(78, 115, 223, 0.7)',
                        'rgba(28, 200, 138, 0.7)',
                        'rgba(246, 194, 62, 0.7)'
                    ],
                    borderColor: [
                        'rgba(78, 115, 223, 1)',
                        'rgba(28, 200, 138, 1)',
                        'rgba(246, 194, 62, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}% 成交量`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 创建权利金差异图表
    function createPremiumSpreadChart(data, exchanges) {
        const ctx = document.getElementById('premium-spread-chart').getContext('2d');
        
        // 计算每个交易所的平均权利金
        const premiumData = {};
        exchanges.forEach(exchange => {
            const exchangeData = data.filter(item => item.exchange === exchange);
            if (exchangeData.length > 0) {
                const avgPremium = exchangeData.reduce((sum, item) => sum + item.premium, 0) / exchangeData.length;
                premiumData[exchange] = parseFloat(avgPremium.toFixed(2));
            } else {
                premiumData[exchange] = 0;
            }
        });
        
        // 创建图表
        if (window.premiumSpreadChart) {
            window.premiumSpreadChart.destroy();
        }
        
        window.premiumSpreadChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: exchanges,
                datasets: [{
                    label: '平均权利金',
                    data: exchanges.map(exchange => premiumData[exchange]),
                    backgroundColor: [
                        'rgba(78, 115, 223, 0.7)',
                        'rgba(28, 200, 138, 0.7)',
                        'rgba(246, 194, 62, 0.7)'
                    ],
                    borderColor: [
                        'rgba(78, 115, 223, 1)',
                        'rgba(28, 200, 138, 1)',
                        'rgba(246, 194, 62, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '平均权利金'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `平均权利金: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        
        bsToast.show();
        
        // Remove the toast from the DOM after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            toastContainer.removeChild(toast);
        });
    }
</script>
{% endblock %}