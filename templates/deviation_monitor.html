{% extends 'layout.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h3 mb-0 text-gray-800">{{ t('option_deviation_monitor') }}</h1>
        <p class="text-muted">{{ t('monitor_options_with_strike_prices_deviating') }} &plusmn;10% {{ t('from_market_price') }}</p>
    </div>
</div>

<!-- Filters Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-left-primary">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('filters') }}</h6>
            </div>
            <div class="card-body">
                <form id="filter-form" class="row g-3 align-items-end">
                    <!-- Symbol -->
                    <div class="col-md-2 mb-2">
                        <label for="symbol-filter" class="form-label">{{ t('symbol') }}</label>
                        <select class="form-select" id="symbol-filter">
                            {% for sym in symbols %}
                            <option value="{{ sym }}" {% if sym == symbol %}selected{% endif %}>{{ sym }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Exchange -->
                    <div class="col-md-2 mb-2">
                        <label for="exchange-filter" class="form-label">{{ t('exchange') }}</label>
                        <select class="form-select" id="exchange-filter">
                            <option value="deribit" selected>Deribit</option>
                            <option value="binance" {% if exchange == 'binance' %}selected{% endif %}>Binance</option>
                            <option value="okx" {% if exchange == 'okx' %}selected{% endif %}>OKX</option>
                        </select>
                    </div>
                    
                    <!-- Option Type -->
                    <div class="col-md-2 mb-2">
                        <label for="option-type-filter" class="form-label">{{ t('option_type') }}</label>
                        <select class="form-select" id="option-type-filter">
                            <option value="" {% if not option_type %}selected{% endif %}>{{ t('all') }}</option>
                            <option value="call" {% if option_type == 'call' %}selected{% endif %}>Call</option>
                            <option value="put" {% if option_type == 'put' %}selected{% endif %}>Put</option>
                        </select>
                    </div>
                    
                    <!-- Time Period -->
                    <div class="col-md-2 mb-2">
                        <label for="time-period-filter" class="form-label">{{ t('time_period') }}</label>
                        <select class="form-select" id="time-period-filter">
                            {% for period_key, period_info in time_periods.items() %}
                            <option value="{{ period_key }}" {% if period_key == current_time_period %}selected{% endif %}>{{ period_info.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Days -->
                    <div class="col-md-2 mb-2">
                        <label for="days-filter" class="form-label">{{ t('days') }}</label>
                        <select class="form-select" id="days-filter">
                            <option value="1" {% if days == 1 %}selected{% endif %}>1 {{ t('day') }}</option>
                            <option value="3" {% if days == 3 %}selected{% endif %}>3 {{ t('days') }}</option>
                            <option value="7" {% if days == 7 %}selected{% endif %}>7 {{ t('days') }}</option>
                            <option value="14" {% if days == 14 %}selected{% endif %}>14 {{ t('days') }}</option>
                            <option value="30" {% if days == 30 %}selected{% endif %}>30 {{ t('days') }}</option>
                        </select>
                    </div>
                    
                    <!-- Volume Change Filter -->
                    <div class="col-md-2 mb-2">
                        <label for="volume-change-filter" class="form-label">{{ t('volume_change_min') }}</label>
                        <select class="form-select" id="volume-change-filter">
                            <option value="0" {% if volume_change_filter == 0 %}selected{% endif %}>{{ t('all') }}</option>
                            <option value="20" {% if volume_change_filter == 20 %}selected{% endif %}>≥ 20%</option>
                            <option value="50" {% if volume_change_filter == 50 %}selected{% endif %}>≥ 50%</option>
                            <option value="100" {% if volume_change_filter == 100 %}selected{% endif %}>≥ 100%</option>
                        </select>
                    </div>
                    
                    <!-- Show anomalies only -->
                    <div class="col-md-6 mb-2 mt-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="anomaly-only-filter" {% if anomaly_only %}checked{% endif %}>
                            <label class="form-check-label" for="anomaly-only-filter">
                                {{ t('show_anomalies_only') }}
                            </label>
                        </div>
                    </div>
                    
                    <!-- Apply Filters Button -->
                    <div class="col-md-6 mb-2 text-end">
                        <button type="button" class="btn btn-primary" id="apply-filters-btn">
                            {{ t('apply_filters') }}
                        </button>
                        <button type="button" class="btn btn-success ms-2" id="refresh-data-btn">
                            <i class="fas fa-sync-alt"></i> {{ t('refresh') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Risk Monitoring Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-primary">{{ t('volaxivity') }}</div>
                        <div class="risk-value mb-1" id="volaxivity-value">--</div>
                        <div class="progress">
                            <div id="volaxivity-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-area fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-success">{{ t('volatility_skew') }}</div>
                        <div class="risk-value mb-1" id="volatility-skew-value">--</div>
                        <div class="progress">
                            <div id="skew-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-balance-scale fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-info">{{ t('put_call_ratio') }}</div>
                        <div class="risk-value mb-1" id="put-call-ratio-value">--</div>
                        <div class="progress">
                            <div id="pcr-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exchange-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2 risk-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="risk-level text-warning">{{ t('reflexivity_indicator') }}</div>
                        <div class="risk-value mb-1" id="reflexivity-value">--</div>
                        <div class="progress">
                            <div id="reflexivity-indicator" class="progress-bar risk-indicator" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-sync-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exchange Comparison Cards -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('exchange_comparison') }}</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Put/Call Ratio Comparison -->
                    <div class="col-md-4 mb-3">
                        <div class="card border-left-info shadow h-100">
                            <div class="card-header py-2">
                                <h6 class="m-0 font-weight-bold text-info">{{ t('put_call_ratio_comparison') }}</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="pcr-comparison-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Volume Distribution -->
                    <div class="col-md-4 mb-3">
                        <div class="card border-left-primary shadow h-100">
                            <div class="card-header py-2">
                                <h6 class="m-0 font-weight-bold text-primary">{{ t('volume_distribution') }}</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="volume-distribution-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Premium Spread -->
                    <div class="col-md-4 mb-3">
                        <div class="card border-left-success shadow h-100">
                            <div class="card-header py-2">
                                <h6 class="m-0 font-weight-bold text-success">{{ t('premium_spread') }}</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="premium-spread-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Alerts Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-left-danger">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-danger">{{ t('active_deviation_alerts') }}</h6>
            </div>
            <div class="card-body">
                {% if active_alerts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>{{ t('time') }}</th>
                                <th>{{ t('symbol') }}</th>
                                <th>{{ t('exchange') }}</th>
                                <th>{{ t('strike') }}</th>
                                <th>{{ t('deviation') }}</th>
                                <th>{{ t('option_type') }}</th>
                                <th>{{ t('trigger') }}</th>
                                <th>{{ t('action') }}</th>
                            </tr>
                        </thead>
                        <tbody id="active-alerts-body">
                            {% for alert in active_alerts %}
                            <tr data-alert-id="{{ alert.id }}">
                                <td>{{ alert.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ alert.symbol }}</td>
                                <td>{{ alert.exchange }}</td>
                                <td>{{ alert.strike_price }}</td>
                                <td>{{ alert.deviation_percent|round(2) }}%</td>
                                <td>{{ alert.option_type.upper() if alert.option_type else '-' }}</td>
                                <td>{{ alert.trigger_condition }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary acknowledge-alert" data-alert-id="{{ alert.id }}">
                                        <i class="fas fa-check"></i> {{ t('acknowledge') }}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <p class="lead">{{ t('no_active_deviation_alerts') }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('deviation_volume_premium_chart') }}</h6>
            </div>
            <div class="card-body">
                <canvas id="deviation-chart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Deviation Data Table -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">{{ t('deviation_data') }}</h6>
                <div class="dropdown no-arrow">
                    <button class="btn btn-sm btn-outline-secondary" id="export-csv">
                        <i class="fas fa-download fa-sm"></i> {{ t('export_csv') }}
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="deviation-table">
                        <thead>
                            <tr>
                                <th>{{ t('time') }}</th>
                                <th>{{ t('symbol') }}</th>
                                <th>{{ t('exchange') }}</th>
                                <th>{{ t('strike') }}</th>
                                <th>{{ t('market_price') }}</th>
                                <th>{{ t('deviation') }}</th>
                                <th>{{ t('option_type') }}</th>
                                <th>{{ t('expiration') }}</th>
                                <th>{{ t('volume') }}</th>
                                <th>{{ t('volume_change') }}</th>
                                <th>{{ t('premium') }}</th>
                                <th>{{ t('premium_change') }}</th>
                                <th>{{ t('market_change') }}</th>
                                <th>{{ t('status') }}</th>
                            </tr>
                        </thead>
                        <tbody id="deviation-table-body">
                            {% for dev in deviations %}
                            <tr {% if dev.is_anomaly %}class="table-{{ 'info' if dev.anomaly_level == 'attention' else ('warning' if dev.anomaly_level == 'warning' else 'danger') }}"{% endif %}>
                                <td>{{ dev.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ dev.symbol }}</td>
                                <td>{{ dev.exchange }}</td>
                                <td>{{ dev.strike_price }}</td>
                                <td>{{ dev.market_price }}</td>
                                <td>{{ dev.deviation_percent|round(2) }}%</td>
                                <td>{{ dev.option_type.upper() }}</td>
                                <td>{{ dev.expiration_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ dev.volume }}</td>
                                <td>{{ dev.volume_change_percent|round(2) if dev.volume_change_percent else '-' }}%</td>
                                <td>{{ dev.premium }}</td>
                                <td>{{ dev.premium_change_percent|round(2) if dev.premium_change_percent else '-' }}%</td>
                                <td>{{ dev.market_price_change_percent|round(2) if dev.market_price_change_percent else '-' }}%</td>
                                <td>
                                    {% if dev.is_anomaly %}
                                    <span class="badge bg-{{ 'info' if dev.anomaly_level == 'attention' else ('warning' if dev.anomaly_level == 'warning' else 'danger') }}">
                                        {{ dev.anomaly_level.capitalize() }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-success">{{ t('normal') }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" id="toast-container" style="z-index: 5"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/deviation_monitor.js') }}"></script>
{% endblock %}
